import"./main";import"bootstrap/js/dist/tab";import{ezQuery,ezAlert}from"../ezq";import{htmlEntities}from"../utils";import dayjs from"dayjs";import relativeTime from"dayjs/plugin/relativeTime";import $ from"jquery";import CTFd from"../CTFd";import config from"../config";import hljs from"highlight.js";dayjs.extend(relativeTime),CTFd._internal.challenge={};let challenges=[],solves=[],loadChal=t=>{var e=$.grep(challenges,e=>e.id==t)[0];"hidden"===e.type?ezAlert({title:"Challenge Hidden!",body:"You haven't unlocked this challenge yet!",button:"Got it!"}):displayChal(e)},loadChalByName=e=>{var t=e.lastIndexOf("-");let l=[e.slice(0,t),e.slice(t+1)][1];e=$.grep(challenges,e=>e.id==l)[0];displayChal(e)},displayChal=a=>Promise.all([CTFd.api.get_challenge({challengeId:a.id}),$.getScript(config.urlRoot+a.script),$.get(config.urlRoot+a.template)]).then(e=>{var t=CTFd._internal.challenge,l=($("#challenge-window").empty(),t.data=e[0].data,t.preRender(),$("#challenge-window").append(e[0].data.view),$("#challenge-window #challenge-input").addClass("form-control"),$("#challenge-window #challenge-submit").addClass("btn btn-md btn-outline-secondary float-right"),$("#challenge-window").find(".modal-dialog"));if(window.init.theme_settings&&window.init.theme_settings.challenge_window_size)switch(window.init.theme_settings.challenge_window_size){case"sm":l.addClass("modal-sm");break;case"lg":l.addClass("modal-lg");break;case"xl":l.addClass("modal-xl")}$(".challenge-solves").click(function(e){getSolves($("#challenge-id").val())}),$(".nav-tabs a").click(function(e){e.preventDefault(),$(this).tab("show")}),$("#challenge-window").on("hide.bs.modal",function(e){$("#challenge-input").removeClass("wrong"),$("#challenge-input").removeClass("correct"),$("#incorrect-key").slideUp(),$("#correct-key").slideUp(),$("#already-solved").slideUp(),$("#too-fast").slideUp()}),$(".load-hint").on("click",function(e){loadHint($(this).data("hint-id"))}),$("#challenge-submit").click(function(e){e.preventDefault(),$("#challenge-submit").addClass("disabled-button"),$("#challenge-submit").prop("disabled",!0),CTFd._internal.challenge.submit().then(renderSubmissionResponse).then(loadChals).then(markSolves)}),$("#challenge-input").keyup(e=>{13==e.keyCode&&$("#challenge-submit").click()}),t.postRender(),$("#challenge-window").find("pre code").each(function(e){hljs.highlightBlock(this)}),window.location.replace(window.location.href.split("#")[0]+`#${a.name}-`+a.id),$("#challenge-window").modal()});function renderSubmissionResponse(e){var e=e.data,t=$("#result-message"),l=$("#result-notification");let a=$("#challenge-input");l.removeClass(),t.text(e.message),"authentication_required"===e.status?window.location=CTFd.config.urlRoot+"/login?next="+CTFd.config.urlRoot+window.location.pathname+window.location.hash:("incorrect"===e.status?(l.addClass("alert alert-danger alert-dismissable text-center"),l.slideDown(),a.removeClass("correct"),a.addClass("wrong"),setTimeout(function(){a.removeClass("wrong")},3e3)):"correct"===e.status?(l.addClass("alert alert-success alert-dismissable text-center"),l.slideDown(),$(".challenge-solves").text().trim()&&$(".challenge-solves").text(parseInt($(".challenge-solves").text().split(" ")[0])+1+" Solves"),a.val(""),a.removeClass("wrong"),a.addClass("correct")):"already_solved"===e.status?(l.addClass("alert alert-info alert-dismissable text-center"),l.slideDown(),a.addClass("correct")):"paused"===e.status?(l.addClass("alert alert-warning alert-dismissable text-center"),l.slideDown()):"ratelimited"===e.status&&(l.addClass("alert alert-warning alert-dismissable text-center"),l.slideDown(),a.addClass("too-fast"),setTimeout(function(){a.removeClass("too-fast")},3e3)),setTimeout(function(){$(".alert").slideUp(),$("#challenge-submit").removeClass("disabled-button"),$("#challenge-submit").prop("disabled",!1)},3e3))}function markSolves(){challenges.map(e=>{e.solved_by_me&&((e=$(`button[value="${e.id}"]`)).addClass("solved-challenge"),e.prepend("<i class='fas fa-check corner-button-check'></i>"))})}function getSolves(e){return CTFd.api.get_challenge_solves({challengeId:e}).then(e=>{var t=e.data,l=($(".challenge-solves").text(parseInt(t.length)+" Solves"),$("#challenge-solves-names"));l.empty();for(let e=0;e<t.length;e++){var a=t[e].account_id,n=t[e].name,s=dayjs(t[e].date).fromNow(),o=t[e].account_url;l.append('<tr><td><a href="{0}">{2}</td><td>{3}</td></tr>'.format(o,a,htmlEntities(n),s))}})}function loadChals(){return CTFd.api.get_challenge_list().then(function(e){var t,l,a=[],n=$("#challenges-board");challenges=e.data,n.empty();for(let e=challenges.length-1;0<=e;e--)-1==$.inArray(challenges[e].category,a)&&(t=challenges[e].category,a.push(t),l=t.replace(/ /g,"-").hashCode(),(l=$('<div id="{0}-row" class="pt-5">'.format(l)+'<div class="category-header col-md-12 mb-3"></div><div class="category-challenges col-md-12"><div class="challenges-row col-md-12"></div></div></div>')).find(".category-header").append($("<h3>"+t+"</h3>")),n.append(l));for(let t=0;t<=challenges.length-1;t++){var s=challenges[t],o=s.name.replace(/ /g,"-").hashCode(),i=s.category.replace(/ /g,"-").hashCode(),d=$("<div id='{0}' class='col-md-3 d-inline-block'></div>".format(o));let e;e=-1==solves.indexOf(s.id)?$("<button class='btn btn-dark challenge-button w-100 text-truncate pt-3 pb-3 mb-2' value='{0}'></button>".format(s.id)):$("<button class='btn btn-dark challenge-button solved-challenge w-100 text-truncate pt-3 pb-3 mb-2' value='{0}'><i class='fas fa-check corner-button-check'></i></button>".format(s.id));var o=$("<p>{0}</p>".format(s.name)),c=$("<span>{0}</span>".format(s.value));for(let e=0;e<s.tags.length;e++){var r="tag-"+s.tags[e].value.replace(/ /g,"-");d.addClass(r)}e.append(o),e.append(c),d.append(e),$("#"+i+"-row").find(".category-challenges > .challenges-row").append(d)}$(".challenge-button").click(function(e){loadChal(this.value)}),console.log("Challenges loaded successfully:"),challenges.forEach(e=>{console.log(`id=${e.id}, type=${e.type}, name=${e.name}, value=${e.value}, category=${e.category}, requirements=${JSON.stringify(e.requirements)}, tags=`+JSON.stringify(e.tags))})})}function update(){return loadChals().then(markSolves)}$(()=>{update().then(()=>{0<window.location.hash.length&&loadChalByName(decodeURIComponent(window.location.hash.substring(1)))}),$("#challenge-input").keyup(function(e){13==e.keyCode&&$("#challenge-submit").click()}),$(".nav-tabs a").click(function(e){e.preventDefault(),$(this).tab("show")}),$("#challenge-window").on("hidden.bs.modal",function(e){$(".nav-tabs a:first").tab("show"),history.replaceState("",window.document.title,window.location.pathname)}),$(".challenge-solves").click(function(e){getSolves($("#challenge-id").val())}),$("#challenge-window").on("hide.bs.modal",function(e){$("#challenge-input").removeClass("wrong"),$("#challenge-input").removeClass("correct"),$("#incorrect-key").slideUp(),$("#correct-key").slideUp(),$("#already-solved").slideUp(),$("#too-fast").slideUp()})}),setInterval(update,3e5);let displayHint=e=>{ezAlert({title:"Hint",body:e.html,button:"Got it!"})},displayUnlock=t=>{ezQuery({title:"Unlock Hint?",body:"Are you sure you want to open this hint?",success:()=>{CTFd.api.post_unlock_list({},{target:t,type:"hints"}).then(e=>{e.success?CTFd.api.get_hint({hintId:t}).then(e=>{displayHint(e.data)}):ezAlert({title:"Error",body:e.errors.score,button:"Got it!"})})}})},loadHint=t=>{CTFd.api.get_hint({hintId:t}).then(e=>{e.data.content?displayHint(e.data):displayUnlock(t)})};